<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¥­å‹™ äººå“¡é…ç½®æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <h1>ğŸ”¬ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¥­å‹™ äººå“¡é…ç½®æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="subtitle">2025å¹´4æœˆ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœ€é©åŒ–</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <section class="control-panel glass-card">
                <div class="control-header">
                    <h2>âš™ï¸ æœ€é©åŒ–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
                </div>
                <div class="control-body">
                    <button id="optimizeBtn" class="btn btn-primary">
                        <span class="btn-icon">ğŸš€</span>
                        å…¨æ—¥ç¨‹ã‚’æœ€é©åŒ–
                    </button>
                    <button id="downloadBtn" class="btn btn-secondary" disabled>
                        <span class="btn-icon">ğŸ“¥</span>
                        Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <div id="statusMessage" class="status-message"></div>
                </div>
            </section>

            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
            <section class="calendar-section glass-card">
                <div class="section-header">
                    <h2>ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                    <div class="legend">
                        <span class="legend-item"><span class="dot optimized"></span>æœ€é©åŒ–æ¸ˆ</span>
                        <span class="legend-item"><span class="dot pending"></span>æœªå‰²å½“</span>
                    </div>
                </div>
                <div id="calendarGrid" class="calendar-grid">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </section>

            <!-- è©³ç´°ãƒ“ãƒ¥ãƒ¼ -->
            <section class="detail-section glass-card">
                <div class="section-header">
                    <h2>ğŸ“‹ <span id="selectedDateTitle">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</span></h2>
                </div>
                <div id="taskList" class="task-list">
                    <p class="placeholder">å·¦ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ—¥ã®æ¥­å‹™ã¨å‰²ã‚Šå½“ã¦çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </section>

            <!-- ä½œæ¥­è€…ä¸€è¦§ -->
            <section class="persons-section glass-card">
                <div class="section-header">
                    <h2>ğŸ‘¥ ä½œæ¥­è€…ä¸€è¦§</h2>
                </div>
                <div id="personsList" class="persons-grid">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </section>
        </main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="footer">
            <p>Â© 2026 ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¥­å‹™æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ </p>
        </footer>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let appState = {
            dates: [],
            persons: [],
            schedule: [],
            results: {},
            selectedDate: null
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadInitialData();
            setupEventListeners();
        });

        // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadInitialData() {
            try {
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
                const response = await fetch('/api/data');
                const data = await response.json();

                appState.dates = data.dates;
                appState.persons = data.persons;
                appState.schedule = data.schedule;

                renderCalendar();
                renderPersons();
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                setTimeout(() => hideStatus(), 2000);
            } catch (error) {
                showStatus('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                console.error(error);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('optimizeBtn').addEventListener('click', runOptimization);
            document.getElementById('downloadBtn').addEventListener('click', downloadResults);
        }

        // æœ€é©åŒ–å®Ÿè¡Œ
        async function runOptimization() {
            const btn = document.getElementById('optimizeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="btn-icon">â³</span> æœ€é©åŒ–ä¸­...';

            showStatus('æœ€é©åŒ–ã‚’å®Ÿè¡Œä¸­...', 'loading');

            try {
                const response = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    appState.results = data.results;
                    renderCalendar();
                    if (appState.selectedDate) {
                        showDateDetail(appState.selectedDate);
                    }
                    showStatus('æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    document.getElementById('downloadBtn').disabled = false;
                } else {
                    showStatus('æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="btn-icon">ğŸš€</span> å…¨æ—¥ç¨‹ã‚’æœ€é©åŒ–';
            }
        }

        // çµæœã‚’Excelã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadResults() {
            window.location.href = '/api/download';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            appState.schedule.forEach(day => {
                const hasResults = appState.results[day.date] &&
                    Object.values(appState.results[day.date]).some(arr => arr.length > 0);

                const card = document.createElement('div');
                card.className = `calendar-card ${hasResults ? 'optimized' : ''} ${appState.selectedDate === day.date ? 'selected' : ''}`;
                card.onclick = () => selectDate(day.date);

                const date = new Date(day.date);
                const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                const dayOfWeek = dayNames[date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                card.innerHTML = `
                    <div class="card-date ${isWeekend ? 'weekend' : ''}">
                        <span class="month">${date.getMonth() + 1}æœˆ</span>
                        <span class="day">${date.getDate()}</span>
                        <span class="weekday">(${dayOfWeek})</span>
                    </div>
                    <div class="card-info">
                        <span class="task-count">${day.task_count}ä»¶</span>
                        ${hasResults ? '<span class="badge optimized">âœ“</span>' : '<span class="badge pending">æœª</span>'}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // æ—¥ä»˜é¸æŠ
        function selectDate(dateStr) {
            appState.selectedDate = dateStr;
            renderCalendar();
            showDateDetail(dateStr);
        }

        // æ—¥ä»˜è©³ç´°è¡¨ç¤º
        async function showDateDetail(dateStr) {
            const titleEl = document.getElementById('selectedDateTitle');
            const listEl = document.getElementById('taskList');

            const date = new Date(dateStr);
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            titleEl.textContent = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ (${dayNames[date.getDay()]})`;

            try {
                const response = await fetch(`/api/schedule/${dateStr}`);
                const data = await response.json();

                if (data.success) {
                    renderTaskList(data.tasks, data.assignments);
                }
            } catch (error) {
                listEl.innerHTML = '<p class="error">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆæç”»
        function renderTaskList(tasks, assignments) {
            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';

            tasks.forEach(taskName => {
                const assigned = assignments[taskName] || [];
                const card = document.createElement('div');
                card.className = `task-card ${assigned.length > 0 ? 'assigned' : 'unassigned'}`;

                card.innerHTML = `
                    <div class="task-name">${taskName}</div>
                    <div class="task-assignment">
                        ${assigned.length > 0
                        ? assigned.map(p => `<span class="person-tag">${p}</span>`).join('')
                        : '<span class="no-assignment">æœªå‰²å½“</span>'
                    }
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        // ä½œæ¥­è€…ä¸€è¦§æç”»
        function renderPersons() {
            const container = document.getElementById('personsList');
            container.innerHTML = '';

            appState.persons.forEach(person => {
                const card = document.createElement('div');
                card.className = 'person-card';

                const notes = person.notes || '';

                card.innerHTML = `
                    <div class="person-name">${person.name}</div>
                    ${notes ? `<div class="person-notes">${notes}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }
    </script>
</body>

</html>